<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RECOVERY OCR v3.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script async src="opencv_v1.js" 
            onload="addLog('âœ… OpenCV Engine Loaded.'); onOpenCvReady();" 
            onerror="addLog('âš ï¸ OpenCV Missing. Using Basic OCR Mode.'); onOpenCvFail();"></script>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen p-4 font-mono text-[10px]">

    <header class="max-w-md mx-auto mb-4 border-b border-slate-800 pb-2 flex justify-between">
        <h1 class="font-black text-blue-500 italic">SYSTEM BYPASS v3.2</h1>
        <div id="setup-status" class="text-red-500 font-bold tracking-widest">BOOTING...</div>
    </header>

    <div class="max-w-md mx-auto bg-slate-900 rounded-2xl p-2 border border-slate-800 shadow-2xl">
        <video id="video" autoplay playsinline class="w-full aspect-video rounded-xl bg-black object-cover shadow-inner"></video>
    </div>

    <div class="max-w-md mx-auto mt-4 bg-black border border-slate-800 rounded p-2 h-32 overflow-y-auto text-slate-500 shadow-inner" id="log-console"></div>

    <div class="max-w-md mx-auto mt-4 space-y-4">
        <button id="scan-btn" class="w-full py-4 bg-blue-600 text-white rounded-xl font-black text-lg shadow-lg active:scale-95 transition-all">
            ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œ
        </button>
        <div id="ocr-result" class="bg-slate-900 p-4 rounded-xl border border-slate-800 min-h-[5rem] text-xs whitespace-pre-wrap">---</div>
    </div>

    <canvas id="canvas-debug" class="hidden"></canvas>

    <script>
        const logConsole = document.getElementById('log-console');
        const scanBtn = document.getElementById('scan-btn');
        const statusText = document.getElementById('setup-status');
        let cvReady = false;

        function addLog(msg) {
            const line = document.createElement('div');
            line.innerHTML = `> ${msg}`;
            logConsole.appendChild(line);
            logConsole.scrollTop = logConsole.scrollHeight;
        }

        function onOpenCvReady() {
            cvReady = true;
            statusText.innerText = "HI-RES MODE";
            statusText.className = "text-green-500 font-bold";
            addLog("âœ¨ Image Enhancement Engine Active.");
        }

        function onOpenCvFail() {
            statusText.innerText = "BASIC MODE";
            statusText.className = "text-yellow-500 font-bold";
            addLog("â„¹ï¸ Operating in Normal Mode (No Filters).");
        }

        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
            .then(s => { document.getElementById('video').srcObject = s; addLog("ğŸ“· Camera Active."); })
            .catch(e => addLog("âŒ Camera Error: Use HTTPS."));

        scanBtn.onclick = async () => {
            addLog("âš¡ Scanning...");
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            // OpenCVãŒã‚ã‚‹å ´åˆã®ã¿é«˜åº¦ãªãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨
            if (cvReady && typeof cv !== 'undefined') {
                try {
                    addLog("ğŸ§  Applying Hi-Res Filters...");
                    let src = cv.imread(canvas);
                    let dst = new cv.Mat();
                    cv.cvtColor(src, src, cv.COLOR_RGBA2GRAY, 0);
                    cv.adaptiveThreshold(src, dst, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, 11, 2);
                    cv.imshow('canvas-debug', dst);
                    src.delete(); dst.delete();
                } catch(e) {
                    addLog("âš ï¸ Filter Error. Falling back...");
                    ctx.drawImage(video, 0, 0); // ãã®ã¾ã¾ã®ç”»åƒã‚’ä½¿ç”¨
                }
            } else {
                addLog("ğŸ” Basic Recognition...");
                const debugCanvas = document.getElementById('canvas-debug');
                debugCanvas.width = canvas.width;
                debugCanvas.height = canvas.height;
                debugCanvas.getContext('2d').drawImage(canvas, 0, 0);
            }

            try {
                const worker = await Tesseract.createWorker('jpn+eng');
                const { data: { text } } = await worker.recognize(document.getElementById('canvas-debug'));
                await worker.terminate();
                document.getElementById('ocr-result').innerText = text.trim() || "(No Text Detected)";
                addLog("âœ… Process Complete.");
            } catch(e) {
                addLog(`âŒ OCR Error: ${e.message}`);
            }
        };
    </script>
</body>
</html>
