<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEBUG OCR - Executive Strategic Partner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script async src="https://docs.opencv.org/4.5.4/opencv.js" id="opencv-js" 
            onload="addLog('‚úÖ OpenCV.js Loaded'); onOpenCvReady();" 
            onerror="addLog('‚ùå OpenCV.js Load Failed');"></script>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen p-4 font-mono">

    <header class="max-w-md mx-auto mb-4 border-b border-slate-800 pb-2">
        <h1 class="text-xl font-black text-blue-500 italic">SYSTEM DEBUG MODE v2.3</h1>
    </header>

    <div class="max-w-md mx-auto bg-slate-900 rounded-2xl p-2 border border-slate-800 shadow-2xl">
        <div class="relative rounded-xl overflow-hidden aspect-video bg-black">
            <video id="video" autoplay playsinline class="w-full h-full object-cover"></video>
            <div id="loader" class="absolute inset-0 bg-black/80 flex flex-col items-center justify-center hidden">
                <div class="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                <p class="mt-4 text-[10px] font-bold text-blue-400">PROCESSING...</p>
            </div>
        </div>
    </div>

    <div class="max-w-md mx-auto mt-4 bg-black border border-slate-700 rounded-lg p-2 h-40 overflow-y-auto text-[10px] leading-relaxed shadow-inner" id="log-console">
        <div class="text-green-500 font-bold border-b border-slate-800 mb-1 pb-1">-- SYSTEM LOG TERMINAL --</div>
    </div>

    <div class="max-w-md mx-auto mt-4 space-y-3">
        <button id="scan-btn" disabled class="w-full py-4 bg-slate-800 text-slate-500 rounded-xl font-black text-lg transition-all">
            WAITING FOR INITIALIZE...
        </button>

        <div class="grid grid-cols-1 gap-2">
            <div class="bg-slate-900 p-3 rounded-lg border border-slate-800">
                <label class="text-[8px] text-blue-400 font-bold block mb-1">OCR RESULT:</label>
                <div id="ocr-result" class="text-sm font-bold min-h-[1.5rem]">---</div>
            </div>
        </div>
    </div>

    <canvas id="canvas-debug" class="hidden"></canvas>

    <script>
        const logConsole = document.getElementById('log-console');
        const scanBtn = document.getElementById('scan-btn');
        const ocrResult = document.getElementById('ocr-result');
        const loader = document.getElementById('loader');

        // „É≠„Ç∞ËøΩÂä†Èñ¢Êï∞
        function addLog(msg) {
            const now = new Date();
            const time = `${now.getHours()}:${now.getMinutes()}:${now.getSeconds()}`;
            const line = document.createElement('div');
            line.innerHTML = `<span class="text-slate-500">[${time}]</span> ${msg}`;
            logConsole.appendChild(line);
            logConsole.scrollTop = logConsole.scrollHeight;
            console.log(`[LOG] ${msg}`);
        }

        addLog("üöÄ App Started.");

        // OpenCV„É≠„Éº„ÉâÂÆå‰∫Ü
        function onOpenCvReady() {
            addLog("‚úÖ OpenCV Kernel Initialized.");
            scanBtn.disabled = false;
            scanBtn.innerText = "„Çπ„Ç≠„É£„É≥ÂÆüË°å";
            scanBtn.className = "w-full py-4 bg-blue-600 text-white rounded-xl font-black text-lg shadow-lg";
        }

        // „Ç´„É°„É©ÂàùÊúüÂåñ
        addLog("üì∑ Requesting Camera Access...");
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
            .then(s => {
                document.getElementById('video').srcObject = s;
                addLog("‚úÖ Camera Stream Connected.");
            })
            .catch(e => {
                addLog(`‚ùå Camera Error: ${e.message}`);
                addLog("‚ö†Ô∏è HTTPSÁí∞Â¢É„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
            });

        scanBtn.onclick = async () => {
            addLog("üñ± Scan Button Clicked.");
            loader.classList.remove('hidden');
            
            try {
                const video = document.getElementById('video');
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);
                addLog(`üì∏ Frame Captured: ${canvas.width}x${canvas.height}`);

                // OpenCVÂâçÂá¶ÁêÜ
                addLog("üß† Applying OpenCV Filters...");
                let src = cv.imread(canvas);
                let dst = new cv.Mat();
                cv.cvtColor(src, src, cv.COLOR_RGBA2GRAY, 0);
                cv.adaptiveThreshold(src, dst, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, 11, 2);
                cv.imshow('canvas-debug', dst);
                addLog("‚úÖ Pre-processing Done.");

                // Tesseract
                addLog("üîç Initializing Tesseract Worker...");
                const worker = await Tesseract.createWorker('jpn+eng', 1, {
                    logger: m => {
                        if(m.status === 'recognizing text') {
                            addLog(`‚è≥ OCR Progress: ${Math.round(m.progress * 100)}%`);
                        }
                    }
                });
                
                addLog("üìñ Executing Recognition...");
                const { data: { text } } = await worker.recognize(document.getElementById('canvas-debug'));
                await worker.terminate();

                addLog("‚ú® Success!");
                ocrResult.innerText = text || "(No Text Detected)";
                
                src.delete(); dst.delete();
            } catch (err) {
                addLog(`‚ùå ERROR: ${err.message}`);
            } finally {
                loader.classList.add('hidden');
            }
        };
    </script>
</body>
</html>
